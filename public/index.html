<!-- public/index.html -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Audio Chat</title>
    <style>
      #audio-box {
        border: 1px solid #ccc;
        padding: 10px;
      }
    </style>
  </head>

  <body>
    <h1>WebRTC Audio Chat</h1>
    <div>
      <label for="room-input">Enter Room Name:</label>
      <input type="text" id="room-input" />
      <button onclick="joinRoom()">Join Room</button>
    </div>
    <div id="audio-box"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let localStream;
      let peerConnections = {};

      const joinRoom = () => {
        const roomInput = document.getElementById("room-input");
        const roomName = roomInput.value.trim();

        socket.emit("join-room", roomName);

        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            localStream = stream;
            const audio = new Audio();
            audio.srcObject = stream;
            audio.play();

            socket.on("user-connected", (userId, clients) => {
              console.log("User connected:", userId);
              createPeerConnection(userId, stream);
              clients.forEach((client) => {
                if (client !== userId && !peerConnections[client]) {
                  createPeerConnection(client, stream);
                }
              });
            });

            socket.on("user-disconnected", (userId, clients) => {
              console.log("User disconnected:", userId);
              if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
              }
            });
          })
          .catch((error) =>
            console.error("Error accessing microphone:", error)
          );
      };

      const createPeerConnection = (userId, stream) => {
        const peerConnection = new RTCPeerConnection();

        peerConnection.addStream(stream);

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("ice-candidate", event.candidate, userId);
          }
        };

        peerConnection.onnegotiationneeded = () => {
          peerConnection
            .createOffer()
            .then((offer) => {
              return peerConnection.setLocalDescription(offer);
            })
            .then(() => {
              socket.emit("offer", peerConnection.localDescription, userId);
            });
        };

        peerConnection.onaddstream = (event) => {
          const audioBox = document.getElementById("audio-box");
          const audioElement = document.createElement("audio");
          audioElement.srcObject = event.stream;
          audioElement.play();
          audioBox.appendChild(audioElement);
        };

        peerConnections[userId] = peerConnection;
        return peerConnection;
      };
    </script>
  </body>
</html>
